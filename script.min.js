function updateAge(){const birthDate=new Date(2006,0,4);const now=new Date;let age=now.getFullYear()-birthDate.getFullYear();const m=now.getMonth()-birthDate.getMonth();if(m<0||m===0&&now.getDate()<birthDate.getDate()){age--}const ageEl=document.getElementById("age");if(ageEl){ageEl.textContent=age}}updateAge();function updateClock(){const clockEl=document.getElementById("clock");if(clockEl){const now=new Date;const options={hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:"America/Chicago",hour12:true};try{clockEl.textContent=now.toLocaleTimeString("en-US",options)+" CT"}catch(e){clockEl.textContent="Time N/A"}}}updateClock();setInterval(updateClock,1e3);document.addEventListener("mousemove",function(e){const sparkle=document.createElement("div");sparkle.classList.add("sparkle");sparkle.style.left=e.pageX-3+"px";sparkle.style.top=e.pageY-3+"px";document.body.appendChild(sparkle);setTimeout(()=>{sparkle.remove()},800)});document.querySelectorAll('.nav-right a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();const targetId=this.getAttribute("href");const targetElement=document.querySelector(targetId);if(targetElement){targetElement.scrollIntoView({behavior:"smooth"})}})});

// --- Last.fm Music Scrobbler (v3 - Server-Side Start Time) ---
document.addEventListener("DOMContentLoaded", () => {
    // A more responsive polling interval now that the logic is simple
    const POLLING_INTERVAL = 5000; // Check every 5 seconds
    const PROGRESS_UPDATE_INTERVAL = 500; // Update bar every 0.5s

    const lastFmContainer = document.getElementById('lastfm-container');
    const trackNameEl = document.getElementById('lastfm-track-name');
    const artistNameEl = document.getElementById('lastfm-artist-name');
    const progressBarEl = document.getElementById('progress-bar-foreground');

    let progressInterval = null;

    function updateProgressBar(startTime, duration) {
        if (!duration || !startTime) {
            progressBarEl.style.width = '0%';
            return;
        };

        const elapsedTime = Date.now() - startTime;
        let progress = (elapsedTime / duration) * 100;
        progress = Math.min(progress, 100); // Don't let it go over 100%

        progressBarEl.style.width = `${progress}%`;
    }

    // (This is the full, corrected function for script.min.js)
    async function fetchLastFmTrack() {
        const proxyUrl = 'https://lastfm-api-proxy.sanyamg2006.workers.dev/'; // <-- YOUR URL

        try {
            const response = await fetch(proxyUrl);
            const data = await response.json();

            if (data.now_playing && data.name) { // Add a check to ensure data.name exists
                // Get references to the elements inside the function for safety
                const trackLinkEl = document.getElementById('lastfm-track-name');
                const artistNameEl = document.getElementById('lastfm-artist-name');

                // --- THE FIX ---
                // Explicitly set the text and the href attribute on the anchor tag
                trackLinkEl.textContent = data.name;
                trackLinkEl.href = data.url;
                artistNameEl.textContent = data.artist;

                // Clear any existing interval to prevent duplicates
                if (progressInterval) clearInterval(progressInterval);
                
                // Immediately update the progress bar to the correct position
                updateProgressBar(data.start_time_ms, data.duration_ms);
                
                // Start the interval to animate the progress bar
                progressInterval = setInterval(() => {
                    updateProgressBar(data.start_time_ms, data.duration_ms);
                }, PROGRESS_UPDATE_INTERVAL);

                // Make the container visible
                lastFmContainer.style.display = 'flex';
            } else {
                // If nothing is playing, hide the container and stop the interval
                lastFmContainer.style.display = 'none';
                if (progressInterval) clearInterval(progressInterval);
            }
        } catch (error) {
            console.error('Error fetching from proxy:', error);
            lastFmContainer.style.display = 'none';
            if (progressInterval) clearInterval(progressInterval);
        }
    }

    fetchLastFmTrack();
    setInterval(fetchLastFmTrack, POLLING_INTERVAL);
});